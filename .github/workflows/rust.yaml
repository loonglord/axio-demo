name: Axio Demo CI

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/**"
      - "migrations/**"
      - "src/**"
      - "Cargo.toml"

jobs:
  validate-axio-demo:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: axio
          POSTGRES_PASSWORD: 4x10
          POSTGRES_DB: axio
        ports: [5432:5432]
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

      redis:
        image: redis:7
        ports: [6379:6379]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

    env:
      DATABASE_URL: postgres://axio:4x10@127.0.0.1:5432/axio

    steps:
      - name: æ‹‰å–ç¤ºä¾‹ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: å®‰è£… sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features postgres

      - name: ç¼“å­˜ Rust ä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: ç­‰å¾… PostgreSQL å°±ç»ªå¹¶æ‰§è¡Œè¿ç§»
        run: |
          until pg_isready -h localhost -p 5432 -U axio; do sleep 1; done
          sqlx migrate run --source migrations/

      - name: æ£€æŸ¥ä»£ç æ ¼å¼åŒ–
        run: cargo fmt --check

      - name: è¿è¡Œ Clippy é™æ€æ£€æŸ¥
        run: cargo clippy -- -D warnings

      - name: æ„å»º axio ç¤ºä¾‹é¡¹ç›®
        run: cargo build --release

      - name: å¯åŠ¨ axio ç¤ºä¾‹æœåŠ¡
        run: |
          nohup cargo run --release > axio-demo.log 2>&1 &
          for i in {1..10}; do
            if curl -s http://localhost:8000/; then
              echo "âœ… axio ç¤ºä¾‹æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
              exit 0
            fi
            sleep 1
          done
          echo "âŒ axio ç¤ºä¾‹æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
          cat axio-demo.log
          exit 1

      - name: æµ‹è¯• axio ç¤ºä¾‹æ¥å£
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          # æµ‹è¯•æ ¹æ¥å£
          echo "ğŸ” æµ‹è¯•æ ¹æ¥å£ /"
          ROOT_RES=$(curl -s http://localhost:8000/)
          if [ "$ROOT_RES" != "Hello, axio-demo!" ]; then
            echo "âŒ æ ¹æ¥å£æµ‹è¯•å¤±è´¥ï¼šé¢„æœŸ 'Hello, axio-demo!'ï¼Œå®é™… '$ROOT_RES'"
            exit 1
          fi
          echo "âœ… æ ¹æ¥å£æµ‹è¯•é€šè¿‡ï¼"

          # æµ‹è¯•ç”¨æˆ·åˆ›å»ºæ¥å£
          echo "ğŸ” æµ‹è¯•ç”¨æˆ·åˆ›å»ºæ¥å£ /users"
          USER_RES=$(curl -s -X POST -H "Content-Type: application/json" -d '{"username":"axio_demo_user"}' http://localhost:8000/users)
          if ! echo "$USER_RES" | jq -e '.id != null and .username == "axio_demo_user"'; then
            echo "âŒ /users æ¥å£æµ‹è¯•å¤±è´¥ï¼šå“åº” = $USER_RES"
            exit 1
          fi
          echo "âœ… /users æ¥å£æµ‹è¯•é€šè¿‡ï¼"
